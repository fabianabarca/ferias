{% extends 'base.html' %}

{% load static %}

{% block page_title %} {{ title }} {% endblock %}

{% block bg-navbar %} background-amarillo {% endblock %}

{% block main %}

<div id="recipe-form" class="container my-5">
    <h1 class="mb-4">{{ title }}</h1>

    <div class="card p-4">


        <form
            action="{% if recipe.slug %}{% url 'edit_recipe' recipe.slug %}{% else %}{% url 'create_recipe' %}{% endif %}"
            method="POST"
            enctype="multipart/form-data"
        >

            {% csrf_token %}

            <!-- Formulario de receta -->
            <div class="row mt-2">
                <div class="col-8">
                    <div class="form-group mb-3">
                        {{ recipe_form.id }}
                        {{ recipe_form }}
                    </div>
                </div>
            </div>


            <!-- Formulario de ingredientes -->
            <div class="row mt-2">
                <div class="col-8">
                    <button type="button" class="btn btn-secondary" hx-get="{% url 'recipe_ingredient_form' 0 recipe.slug %}" hx-target="#ingredients-list" hx-swap="beforeend">Agregar ingredientes</button>
                    <a class="btn btn-success" onclick="saveIngredients()">Guardar ingredientes</a>

                    <div id="ingredients-list">
                    {{ ingredient_formset.management_form }}
                    {% for form in ingredient_formset %}
                    <div class="ingredient my-3">
                        <div class="ingredient-row mb-3">
                            {{ form }}
                        </div>
                    </div>
                    {% endfor %}
                    </div>
                </div>
            </div>


            <!-- Formulario de pasos -->
            <div class="row mt-2">
                <div class="col-8">
                    <button type="button" class="btn btn-secondary" hx-get="{% url 'recipe_step_form' 0 recipe.slug %}" hx-target="#steps-list" hx-swap="beforeend">Agregar pasos</button>
                    <a class="btn btn-success" onclick="saveSteps()">Guardar pasos</a>

                    <div id="steps-list">
                        {{ step_formset.management_form }}
                        {% for form in step_formset %}
                        <div class="step my-3">
                            <div class="step-row mb-3">
                                {{ form }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <button type="submit" class="btn btn-success mt-3">Guardar receta</button>
        </form>



    </div>
</div>

<script>
    function saveIngredients() {
        const ingredientsList = document.getElementById('ingredients-list');
        const ingredientElements = ingredientsList.getElementsByClassName('ingredient-row');

        const totalFormInputs = ingredientsList.querySelectorAll('[name$="recipeingredient_set-TOTAL_FORMS"]');
        totalFormInputs.forEach(input => input.value=ingredientElements.length);

        const initialFormInputs = ingredientsList.querySelectorAll('[name$="recipeingredient_set-INITIAL_FORMS"]');
        initialFormInputs.forEach(input => input.value=0);

        const minFormInputs = ingredientsList.querySelectorAll('[name$="recipeingredient_set-MIN_NUM_FORMS"]');
        minFormInputs.forEach(input => input.value=ingredientElements.length);
    }

    function saveSteps() {
        const stepsList = document.getElementById('steps-list');
        const stepElements = stepsList.getElementsByClassName('step-row');

        const totalFormInputs = stepsList.querySelectorAll('[name$="step_set-TOTAL_FORMS"]');
        totalFormInputs.forEach(input => input.value=stepElements.length);

        const initialFormInputs = stepsList.querySelectorAll('[name$="step_set-INITIAL_FORMS"]');
        initialFormInputs.forEach(input => input.value=0);

        const minFormInputs = stepsList.querySelectorAll('[name$="step_set-MIN_NUM_FORMS"]');
        minFormInputs.forEach(input => input.value=stepElements.length);
    }
</script>
    


{% endblock %}